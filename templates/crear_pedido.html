{% extends "base.html" %}
{% block content %}
<h2>Crear Pedido</h2>

<!-- Buscador / paginaciÃ³n controls -->
<form method="get" action="{{ url_for('crear_pedido') }}" class="row g-2 mb-3">
  <div class="col-md-6">
    <input class="form-control" name="search" placeholder="Buscar producto..." value="{{ search or '' }}">
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary">Buscar</button>
  </div>
</form>

<div class="row mb-3">
  <div class="col-md-6">
    <label>Cliente</label>
    <select id="selectCliente" class="form-select">
      <option value="">-- Seleccionar cliente --</option>
      {% for c in clientes %}
        <option value="{{ c.id }}">{{ c.nombre }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-6">
    <label>Producto</label>
    <div class="input-group">
      <select id="selectProducto" class="form-select">
        <option value="">-- Seleccionar producto --</option>
        {% for p in productos %}
          <option value="{{ p.id }}"
                  data-nombre="{{ p.nombre }}"
                  data-precio="{{ p.precio }}"
                  data-stock="{{ p.stock }}"
                  data-laboratorio="{{ p.laboratorio or '' }}">
            {{ p.nombre }} â€” ${{ "%.2f"|format(p.precio) }} (Stock: {{ p.stock }})
          </option>
        {% endfor %}
      </select>
      <input id="inputCantidad" type="number" min="1" value="1" class="form-control" style="max-width:120px">
      <button id="btnAdd" type="button" class="btn btn-outline-primary">âž• Agregar</button>
    </div>
  </div>
</div>

<!-- Carrito dinÃ¡mico -->
<h4>Carrito</h4>
<table class="table table-bordered" id="cartTable">
  <thead><tr><th>Producto</th><th>Laboratorio</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th>Acciones</th></tr></thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <th colspan="4" class="text-end">Total</th>
      <th id="cartTotal">$0.00</th>
      <th></th>
    </tr>
  </tfoot>
</table>

<!-- Hidden form to post cart JSON -->
<form id="finalForm" method="post" action="{{ url_for('guardar_pedido') }}">
  <input type="hidden" name="cliente_id" id="formClienteId">
  <input type="hidden" name="cart_json" id="formCartJson">
  <button id="btnGenerate" type="submit" class="btn btn-success">ðŸ“„ Generar Pedido (PDF)</button>
  <button id="btnClearCart" type="button" class="btn btn-secondary ms-2">Vaciar carrito</button>
</form>

<!-- Pagination -->
<nav class="mt-3">
  <ul class="pagination">
    {% if page > 1 %}
      <li class="page-item"><a class="page-link" href="{{ url_for('crear_pedido', page=page-1, search=search) }}">Anterior</a></li>
    {% endif %}
    {% if page < pages %}
      <li class="page-item"><a class="page-link" href="{{ url_for('crear_pedido', page=page+1, search=search) }}">Siguiente</a></li>
    {% endif %}
  </ul>
</nav>

<script>
  // Keys for storage
  const STORAGE_KEY = "carrito_v1";
  const CLIENTE_KEY = "cliente_v1";

  // Carrito en memoria (cliente)
  let cart = []; // {id, nombre, laboratorio, precio, cantidad, stock}

  const selectProducto = document.getElementById("selectProducto");
  const inputCantidad = document.getElementById("inputCantidad");
  const btnAdd = document.getElementById("btnAdd");
  const cartTableBody = document.querySelector("#cartTable tbody");
  const cartTotalEl = document.getElementById("cartTotal");
  const formClienteId = document.getElementById("formClienteId");
  const selectClienteEl = document.getElementById("selectCliente");
  const formCartJson = document.getElementById("formCartJson");
  const finalForm = document.getElementById("finalForm");
  const btnClearCart = document.getElementById("btnClearCart");

  // Save cart + cliente to localStorage
  function saveStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
      localStorage.setItem(CLIENTE_KEY, selectClienteEl.value || "");
    } catch (e) {
      console.warn("No se pudo guardar el carrito en localStorage:", e);
    }
  }

  // Load cart from localStorage (si existe)
  function loadStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          // ensure types
          cart = parsed.map(it => ({
            id: it.id,
            nombre: it.nombre || null,
            laboratorio: it.laboratorio || "",
            precio: (it.precio !== undefined) ? Number(it.precio) : null,
            cantidad: Number(it.cantidad) || 0,
            stock: (it.stock !== undefined) ? Number(it.stock) : null
          }));
        }
      }
      const savedCliente = localStorage.getItem(CLIENTE_KEY);
      if (savedCliente) {
        // try set, but maybe option not present in this page â€” still set the hidden input on submit
        selectClienteEl.value = savedCliente;
      }
    } catch (e) {
      console.warn("No se pudo cargar carrito desde localStorage:", e);
    }
  }

  // Try to enrich an item (if falta nombre/precio) buscando en el select global
  function enrichItemFromSelect(it) {
    if ((!it.nombre || it.precio === null || it.precio === undefined) && selectProducto) {
      const opt = document.querySelector(`#selectProducto option[value="${it.id}"]`);
      if (opt) {
        it.nombre = it.nombre || opt.dataset.nombre || opt.textContent.trim();
        it.precio = (it.precio === null || it.precio === undefined) ? (parseFloat(opt.dataset.precio) || 0) : it.precio;
        it.stock = (it.stock === null || it.stock === undefined) ? (parseInt(opt.dataset.stock) || 0) : it.stock;
        it.laboratorio = it.laboratorio || opt.dataset.laboratorio || "";
      }
    }
    // ensure defaults
    it.nombre = it.nombre || "Producto";
    it.precio = Number(it.precio || 0);
    it.stock = Number(it.stock || 0);
    it.cantidad = Number(it.cantidad || 0);
    return it;
  }

  function renderCart() {
    cartTableBody.innerHTML = "";
    let total = 0;
    cart.forEach((it, idx) => {
      // try to enrich with current select data if some fields missing
      it = enrichItemFromSelect(it);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.nombre}</td>
        <td>${it.laboratorio || ''}</td>
        <td><input type="number" min="1" max="${it.stock}" value="${it.cantidad}" data-idx="${idx}" class="form-control cart-qty" style="width:80px"></td>
        <td>$${Number(it.precio).toFixed(2)}</td>
        <td>$${(Number(it.precio) * Number(it.cantidad)).toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-danger btn-remove" data-idx="${idx}">Eliminar</button>
        </td>`;
      cartTableBody.appendChild(tr);
      total += Number(it.precio) * Number(it.cantidad);
    });
    cartTotalEl.textContent = `$${total.toFixed(2)}`;

    // attach events
    document.querySelectorAll(".btn-remove").forEach(b => {
      b.onclick = () => {
        const i = parseInt(b.dataset.idx);
        cart.splice(i,1);
        saveStorage();
        renderCart();
      };
    });
    document.querySelectorAll(".cart-qty").forEach(input => {
      input.onchange = () => {
        const i = parseInt(input.dataset.idx);
        let v = parseInt(input.value) || 0;
        if (v < 1) v = 1;
        if (cart[i].stock && v > cart[i].stock) {
          alert("No hay tanto stock disponible.");
          v = cart[i].stock;
          input.value = v;
        }
        cart[i].cantidad = v;
        saveStorage();
        renderCart();
      };
    });

    // sync hidden form
    formCartJson.value = JSON.stringify(cart.map(it => ({id: it.id, cantidad: it.cantidad})));
  }

  btnAdd.onclick = () => {
    const opt = selectProducto.selectedOptions[0];
    if (!opt) return alert("Selecciona un producto.");
    if (!opt.value) return alert("Selecciona un producto.");
    const pid = opt.value;
    const nombre = opt.dataset.nombre || opt.textContent.trim();
    const precio = parseFloat(opt.dataset.precio) || 0;
    const stock = parseInt(opt.dataset.stock) || 0;
    const laboratorio = opt.dataset.laboratorio || "";
    let qty = parseInt(inputCantidad.value) || 0;
    if (qty <= 0) return alert("Cantidad debe ser mayor a 0.");
    if (qty > stock) return alert("No hay suficiente stock.");

    // si ya estÃ¡ en cart, sumar cantidades (sin superar stock)
    const existing = cart.find(c => c.id === pid);
    if (existing) {
      const newQty = existing.cantidad + qty;
      if (existing.stock && newQty > existing.stock) return alert("Sumando superas el stock disponible.");
      existing.cantidad = newQty;
    } else {
      cart.push({id: pid, nombre, laboratorio, precio, cantidad: qty, stock});
    }
    saveStorage();
    renderCart();
  };

  // Antes de enviar, validar cliente y carrito no vacÃ­o
  finalForm.onsubmit = (e) => {
    const clienteId = selectClienteEl.value;
    if (!clienteId) {
      e.preventDefault();
      alert("Selecciona un cliente antes de generar el pedido.");
      return false;
    }
    if (cart.length === 0) {
      e.preventDefault();
      alert("El carrito estÃ¡ vacÃ­o. Agrega productos antes.");
      return false;
    }
    // set cliente id into hidden input
    formClienteId.value = clienteId;
    // cart JSON already set in renderCart
    return true;
  };

  // Vaciar carrito
  btnClearCart.onclick = () => {
    if (!confirm("Â¿Vaciar el carrito?")) return;
    cart = [];
    saveStorage();
    renderCart();
  };

  // al cambiar cliente guardarlo
  selectClienteEl.onchange = () => {
    try { localStorage.setItem(CLIENTE_KEY, selectClienteEl.value || ""); } catch(e){}
  }

  // init: cargar desde storage y render
  loadStorage();
  renderCart();
</script>
{% endblock %}
